{% extends "base.html" %}

{% block title %}Home - Weave{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Hero section -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
            Automate Your Workflows
        </h1>
        <p class="text-xl text-gray-600">
            Describe what you want to automate, and we'll suggest the perfect workflow for you.
        </p>
    </div>

    <!-- Backend API Status Banner -->
    <div id="api-status-banner" class="hidden mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">Backend API Not Running</h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <p>To use real integrations and generate workflows, you need to start the backend API server.</p>
                    <div class="mt-2">
                        <code class="bg-yellow-100 px-2 py-1 rounded text-xs">python start_both.py</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main form -->
    <div class="bg-white rounded-lg shadow-md p-8">
        <form id="workflow-form">
            <!-- Prompt input -->
            <div class="mb-8">
                <label for="prompt" class="block text-sm font-medium text-gray-700 mb-3">
                    What would you like to automate?
                </label>
                <textarea
                    id="prompt"
                    name="prompt"
                    rows="4"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="e.g., Automatically categorize incoming emails and forward urgent ones to my team's Slack channel"
                    required
                ></textarea>
                <p class="mt-2 text-sm text-gray-500">
                    Be as specific as possible about what you want to accomplish.
                </p>
            </div>

            <!-- Integrations picker -->
            <div class="mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Which integrations do you want to use?
                </label>
                
                <!-- Search input -->
                <div class="mb-4">
                    <input
                        type="text"
                        id="integration-search"
                        placeholder="Search integrations..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>
                
                <!-- Integrations list -->
                <div id="integrations-list" class="border border-gray-300 rounded-md p-4 min-h-[300px] bg-gray-50">
                    <!-- Loading state will show here initially -->
                    <div class="text-center text-gray-500 py-8">
                        <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm text-gray-600">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading integrations...
                        </div>
                    </div>
                </div>
                
                <!-- Selected integrations -->
                <div id="selected-integrations" class="mt-4 flex flex-wrap gap-2">
                    <!-- Selected integration chips will be inserted here -->
                </div>
            </div>

            <!-- Submit button -->
            <div class="text-center">
                <button
                    type="submit"
                    id="submit-btn"
                    class="bg-blue-600 text-white px-8 py-3 rounded-md hover:bg-blue-700 transition-colors font-medium text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Get Suggestions
                </button>
            </div>
        </form>
    </div>

    <!-- Suggestions preview -->
    <div id="suggestions-preview" class="mt-8">
        <!-- Suggestions will be loaded here via API call -->
    </div>
</div>

<!-- Hidden input for integrations -->
<input type="hidden" name="integrations" id="integrations-input">
{% endblock %}

{% block extra_scripts %}
<script>
// Debug: Check if libraries are loaded on home page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Home page loaded');
    
    if (typeof htmx !== 'undefined') {
        console.log('✅ HTMX loaded on home page');
    } else {
        console.error('❌ HTMX not loaded on home page');
    }
    
    if (typeof Alpine !== 'undefined') {
        console.log('✅ Alpine.js loaded on home page');
    } else {
        console.error('❌ Alpine.js not loaded on home page');
    }
    
    // Test if basic event handlers work
    console.log('Testing home page functionality...');
    
    // Test if HTMX is working by checking for htmx attributes
    const htmxElements = document.querySelectorAll('[hx-get], [hx-post], [hx-trigger]');
    console.log('Found HTMX elements:', htmxElements.length);
    htmxElements.forEach(el => {
        console.log('HTMX element:', el.tagName, el.getAttribute('hx-get') || el.getAttribute('hx-post'));
    });
    
    // Test if API is accessible
    async function testAPI() {
        try {
            const response = await fetch('/api/');
            console.log('🌐 API test response:', response.status);
            if (response.ok) {
                const data = await response.json();
                console.log('✅ API is accessible:', data);
                return true;
            }
        } catch (error) {
            console.error('❌ API test failed:', error);
        }
        return false;
    }

    // Check backend API status and show banner if needed
    async function checkBackendAPIStatus() {
        try {
            const response = await fetch('http://localhost:8001/health');
            if (response.ok) {
                console.log('✅ Backend API is accessible');
                document.getElementById('api-status-banner').classList.add('hidden');
            } else {
                throw new Error(`Backend API returned status ${response.status}`);
            }
        } catch (error) {
            console.log('❌ Backend API is not accessible:', error.message);
            document.getElementById('api-status-banner').classList.remove('hidden');
        }
    }

    // Check backend API status on page load
    checkBackendAPIStatus();

    // Load all integrations and implement client-side search
    let selectedIntegrations = new Map(); // id -> name

    function updateIntegrationsInput() {
        // Store IDs in hidden input for form submission
        document.getElementById('integrations-input').value = Array.from(selectedIntegrations.keys()).join(',');
    }

    function toggleIntegration(integrationId, integrationName) {
        if (selectedIntegrations.has(integrationId)) {
            selectedIntegrations.delete(integrationId);
        } else {
            selectedIntegrations.set(integrationId, integrationName);
        }
        updateIntegrationsInput();
        renderSelectedIntegrations();
    }

    function renderSelectedIntegrations() {
        const container = document.getElementById('selected-integrations');
        container.innerHTML = '';
        
        selectedIntegrations.forEach((integrationName, integrationId) => {
            const chip = document.createElement('div');
            chip.className = 'bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center space-x-2';
            chip.innerHTML = `
                <span>${integrationName}</span>
                <button 
                    onclick="toggleIntegration('${integrationId}', '${integrationName}')"
                    class="text-blue-600 hover:text-blue-800"
                >
                    ×
                </button>
            `;
            container.appendChild(chip);
        });
    }

    // Load all integrations and implement client-side search
    let allIntegrations = [];
    let filteredIntegrations = [];

    async function loadAllIntegrations() {
        try {
            console.log('🔄 Loading all integrations...');
            const response = await fetch('http://localhost:8001/api/integrations?limit=1000'); // Get all integrations
            if (response.ok) {
                const data = await response.json();
                allIntegrations = data.items || [];
                filteredIntegrations = [...allIntegrations];
                console.log(`✅ Loaded ${allIntegrations.length} integrations`);
                renderIntegrations(filteredIntegrations);
            } else {
                throw new Error(`Failed to load integrations: ${response.status}`);
            }
        } catch (error) {
            console.error('❌ Error loading integrations:', error);
            document.getElementById('integrations-list').innerHTML = `
                <div class="text-center text-red-500 py-8">
                    <p>Failed to load integrations: ${error.message}</p>
                    <button onclick="loadAllIntegrations()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Retry
                    </button>
                </div>
            `;
        }
    }

    function renderIntegrations(integrations) {
        const container = document.getElementById('integrations-list');
        
        if (!integrations || integrations.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <p class="mt-2">No integrations found</p>
                    <p class="text-sm">Try adjusting your search terms</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="mb-4 text-sm text-gray-600">
                Showing ${integrations.length} of ${allIntegrations.length} integrations
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        `;

        integrations.forEach(integration => {
            const isSelected = selectedIntegrations.has(integration.slug);
            html += `
                <div class="integration-card bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow duration-200 cursor-pointer ${isSelected ? 'ring-2 ring-blue-500' : ''}" 
                     onclick="toggleIntegration('${integration.slug}', '${integration.name}')">
                    <div class="flex items-start space-x-3">
                        <!-- Integration Icon/Logo -->
                        <div class="flex-shrink-0">
                            ${integration.logo ? 
                                `<img src="${integration.logo}" alt="${integration.name}" class="w-10 h-10 rounded-lg">` :
                                `<div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                                    <span class="text-lg font-semibold text-gray-600">${integration.name[0].toUpperCase()}</span>
                                </div>`
                            }
                        </div>
                        
                        <!-- Integration Details -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                <input
                                    type="checkbox"
                                    id="integration-${integration.slug}"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                    ${isSelected ? 'checked' : ''}
                                    onclick="event.stopPropagation()"
                                >
                                <h3 class="text-sm font-medium text-gray-900 truncate">${integration.name}</h3>
                            </div>
                            
                            ${integration.description ? 
                                `<p class="text-xs text-gray-500 line-clamp-2">${integration.description}</p>` : ''
                            }
                            
                            ${integration.category ? 
                                `<div class="mt-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        ${integration.category}
                                    </span>
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    function filterIntegrations(searchTerm) {
        if (!searchTerm.trim()) {
            filteredIntegrations = [...allIntegrations];
        } else {
            const term = searchTerm.toLowerCase();
            filteredIntegrations = allIntegrations.filter(integration => 
                integration.name.toLowerCase().includes(term) ||
                integration.description.toLowerCase().includes(term) ||
                integration.category.toLowerCase().includes(term) ||
                integration.slug.toLowerCase().includes(term)
            );
        }
        renderIntegrations(filteredIntegrations);
    }

    // Set up search functionality
    document.getElementById('integration-search').addEventListener('input', function(e) {
        filterIntegrations(e.target.value);
    });

    // Load all integrations on page load
    loadAllIntegrations();

    // Handle form submission to call API
    document.getElementById('workflow-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const prompt = document.getElementById('prompt').value;
        const integrations = Array.from(selectedIntegrations.keys());
        const submitBtn = document.getElementById('submit-btn');
        const suggestionsPreview = document.getElementById('suggestions-preview');
        
        if (!prompt.trim()) {
            alert('Please enter a prompt');
            return;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Generating...
        `;
        
        suggestionsPreview.innerHTML = `
            <div class="text-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2 text-gray-600">Generating workflow suggestions...</p>
            </div>
        `;
        
        try {
            // Call the API to generate suggestions
            const response = await fetch('http://localhost:8001/api/suggestions:generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_request: prompt,
                    selected_apps: integrations,
                    user_id: 'user_1' // TODO: Get from auth
                })
            });
            
            if (!response.ok) {
                throw new Error(`API call failed: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.suggestions && data.suggestions.length > 0) {
                // Display suggestions and redirect to suggestions page
                const suggestionsParam = encodeURIComponent(JSON.stringify(data.suggestions));
                const promptParam = encodeURIComponent(prompt);
                const integrationsParam = encodeURIComponent(integrations.join(','));
                
                window.location.href = `/suggestions?prompt=${promptParam}&integrations=${integrationsParam}&suggestions=${suggestionsParam}`;
            } else {
                throw new Error('No suggestions generated');
            }
            
        } catch (error) {
            console.error('Error generating suggestions:', error);
            suggestionsPreview.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Error generating suggestions</h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>${error.message}</p>
                            </div>
                            <div class="mt-4">
                                <button
                                    onclick="window.location.reload()"
                                    class="bg-red-100 text-red-800 px-4 py-2 rounded-md hover:bg-red-200 transition-colors text-sm font-medium"
                                >
                                    Try Again
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } finally {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Get Suggestions';
        }
    });

    // Make functions globally available for HTMX
    window.toggleIntegration = toggleIntegration;
    window.updateIntegrationsInput = updateIntegrationsInput;
});
</script>
{% endblock %}
