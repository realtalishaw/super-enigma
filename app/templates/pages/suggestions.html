{% extends "base.html" %}

{% block title %}Workflow Suggestions - Weave{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Top bar with prompt and integrations -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Workflow Suggestions</h1>
                {% if prompt %}
                    <p class="text-gray-600">
                        <span class="font-medium">Prompt:</span> "{{ prompt }}"
                    </p>
                {% endif %}
            </div>
            
            {% if integrations %}
            <div class="flex flex-wrap gap-2" id="top-integrations-container">
                <span class="text-sm text-gray-500">Integrations:</span>
                <!-- Integration names will be populated by JavaScript -->
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Suggestions grid -->
    <div id="suggestions-container">
        {% if prompt %}
            <!-- Display suggestions passed via URL parameters -->
            <div id="suggestions-display">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-2 text-gray-600">Loading suggestions...</p>
                </div>
            </div>
        {% else %}
            <!-- No prompt provided -->
            <div class="text-center py-12">
                <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">No prompt provided</h3>
                <p class="mt-2 text-gray-600">
                    Please go back to the home page and describe what you'd like to automate.
                </p>
                <a href="/" class="mt-4 inline-block bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors font-medium">
                    Go to Home
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
}

.modal-content {
    background-color: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    max-width: 64rem;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.modal-close {
    color: #9CA3AF;
    transition: color 0.2s;
}

.modal-close:hover {
    color: #4B5563;
}

.modal-body {
    margin-bottom: 1rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
}

.json-preview {
    background-color: #F3F4F6;
    padding: 1rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const prompt = urlParams.get('prompt');
    const integrations = urlParams.get('integrations');
    const suggestionsParam = urlParams.get('suggestions');
    
    if (prompt && suggestionsParam) {
        try {
            const suggestions = JSON.parse(decodeURIComponent(suggestionsParam));
            displaySuggestions(suggestions).catch(error => {
                console.error('Error displaying suggestions:', error);
                displayError('Failed to display suggestions');
            });
        } catch (error) {
            console.error('Error parsing suggestions:', error);
            displayError('Failed to load suggestions');
        }
    } else if (prompt) {
        // If no suggestions in URL, try to generate them
        generateSuggestions(prompt, integrations);
    }
    
    // Update the top integrations display with names
    async function updateTopIntegrationsDisplay() {
        if (integrations) {
            const integrationIds = integrations.split(',');
            const integrationNames = await fetchIntegrationNames(integrationIds);
            
            const topIntegrationsContainer = document.getElementById('top-integrations-container');
            if (topIntegrationsContainer) {
                // Remove existing integration spans (keep the "Integrations:" label)
                const existingSpans = topIntegrationsContainer.querySelectorAll('span:not(:first-child)');
                existingSpans.forEach(span => span.remove());
                
                // Add new integration spans
                integrationIds.forEach(int => {
                    const span = document.createElement('span');
                    span.className = 'inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                    span.textContent = getIntegrationDisplayName(int, integrationNames);
                    topIntegrationsContainer.appendChild(span);
                });
            }
        }
    }
    
    // Update top integrations display when page loads
    if (integrations) {
        updateTopIntegrationsDisplay();
    }
    
    // Function to fetch integration names from the database
    async function fetchIntegrationNames(integrationIds) {
        if (!integrationIds || integrationIds.length === 0) return {};
        
        try {
            const response = await fetch('/api/catalog/providers', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (!response.ok) {
                console.warn('Failed to fetch integration names, using IDs');
                return {};
            }
            
            const data = await response.json();
            const integrationNames = {};
            
            // Create a mapping of ID to name
            if (data.providers) {
                data.providers.forEach(provider => {
                    if (provider.id && provider.metadata && provider.metadata.name) {
                        integrationNames[provider.id] = provider.metadata.name;
                    }
                });
            }
            
            return integrationNames;
        } catch (error) {
            console.warn('Error fetching integration names:', error);
            return {};
        }
    }
    
    // Function to get display name for integration
    function getIntegrationDisplayName(integrationId, integrationNames) {
        return integrationNames[integrationId] || integrationId;
    }
    
    async function displaySuggestions(suggestions) {
        const container = document.getElementById('suggestions-display');
        
        if (!suggestions || suggestions.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">No suggestions found</h3>
                    <p class="mt-2 text-gray-600">
                        We couldn't generate workflow suggestions with the current prompt and integrations.
                    </p>
                    <button
                        onclick="generateSuggestions('${prompt}', '${integrations}').catch(error => console.error('Error regenerating:', error))"
                        class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors"
                    >
                        Regenerate
                    </button>
                </div>
            `;
            return;
        }
        
        // Fetch integration names for better display
        const integrationIds = integrations ? integrations.split(',') : [];
        const integrationNames = await fetchIntegrationNames(integrationIds);
        
        // Display suggestions grid
        let suggestionsHtml = `
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Generated Workflows</h2>
                    <p class="text-gray-600">
                        Based on your prompt: <span class="font-medium">"${prompt}"</span>
                    </p>
                    ${integrations ? `
                        <div class="mt-2">
                            <span class="text-sm text-gray-500">Using integrations: </span>
                            ${integrationIds.map(int => 
                                `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs mr-2">${getIntegrationDisplayName(int, integrationNames)}</span>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        `;
        
        suggestions.forEach((suggestion, index) => {
            const apps = suggestion.apps && suggestion.apps.length > 0 ? suggestion.apps.join(', ') : 'Available integrations';
            const confidence = Math.round((suggestion.confidence || 0.8) * 100);
            
            suggestionsHtml += `
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold text-gray-900">${suggestion.title || `Workflow ${index + 1}`}</h3>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                                ${confidence}% match
                            </span>
                        </div>
                        <p class="text-gray-600 text-sm">${suggestion.description || 'Automated workflow'}</p>
                    </div>
                    
                    ${suggestion.apps && suggestion.apps.length > 0 ? `
                        <div class="mb-4">
                            <p class="text-xs text-gray-500 mb-2">Required integrations:</p>
                            <div class="flex flex-wrap gap-1">
                                ${suggestion.apps.map(app => 
                                    `<span class="inline-block bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${app}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${suggestion.dsl_parametric && suggestion.dsl_parametric.actions ? `
                        <div class="mb-4">
                            <details class="text-sm">
                                <summary class="cursor-pointer text-blue-600 hover:text-blue-700 font-medium">
                                    Preview workflow
                                </summary>
                                <div class="mt-2 space-y-1">
                                    ${suggestion.dsl_parametric.trigger ? `
                                        <div class="flex items-center space-x-2">
                                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                            <span class="text-gray-600">Trigger: ${suggestion.dsl_parametric.trigger.type || 'Manual'}</span>
                                        </div>
                                    ` : ''}
                                    ${suggestion.dsl_parametric.actions.map(action => {
                                        // Show more detailed action information
                                        let actionText = action.type || 'Notification';
                                        if (action.name) {
                                            actionText = action.name;
                                        } else if (action.action_type) {
                                            actionText = action.action_type;
                                        } else if (action.function) {
                                            actionText = action.function;
                                        }
                                        
                                        // Add description if available
                                        let actionDesc = '';
                                        if (action.description) {
                                            actionDesc = ` - ${action.description}`;
                                        } else if (action.purpose) {
                                            actionDesc = ` - ${action.purpose}`;
                                        }
                                        
                                        return `
                                            <div class="flex items-center space-x-2">
                                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                                <span class="text-gray-600">Action: ${actionText}${actionDesc}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </details>
                        </div>
                    ` : ''}
                    
                    <div class="flex space-x-2">
                        <button
                            onclick="createWorkflow('${suggestion.suggestion_id}')"
                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
                        >
                            Use This Workflow
                        </button>
                        <button
                            onclick="previewWorkflow('${suggestion.suggestion_id}')"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors text-sm"
                        >
                            Preview
                        </button>
                    </div>
                </div>
            `;
        });
        
        suggestionsHtml += `
                </div>
                
                <div class="mt-8 text-center">
                    <a 
                        href="/?prompt=${encodeURIComponent(prompt)}&integrations=${encodeURIComponent(integrations || '')}"
                        class="inline-block bg-gray-600 text-white px-6 py-3 rounded-md hover:bg-gray-700 transition-colors font-medium"
                    >
                        ← Back to Home
                    </a>
                </div>
            </div>
        `;
        
        container.innerHTML = suggestionsHtml;
    }
    
    function displayError(message) {
        const container = document.getElementById('suggestions-display');
        container.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Error loading suggestions</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p>${message}</p>
                        </div>
                        <div class="mt-4">
                            <a href="/" class="bg-red-100 text-red-800 px-4 py-2 rounded-md hover:bg-red-200 transition-colors text-sm font-medium">
                                Go to Home
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    async function generateSuggestions(prompt, integrations) {
        const container = document.getElementById('suggestions-display');
        
        try {
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-2 text-gray-600">Generating workflow suggestions...</p>
                </div>
            `;
            
            const response = await fetch('/api/suggestions:generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_request: prompt,
                    selected_apps: integrations ? integrations.split(',') : [],
                    user_id: 'user_1' // TODO: Get from auth
                })
            });
            
            if (!response.ok) {
                throw new Error(`API call failed: ${response.status}`);
            }
            
            const data = await response.json();
            await displaySuggestions(data.suggestions);
            
            // Also update the top integrations display
            await updateTopIntegrationsDisplay();
            
        } catch (error) {
            console.error('Error generating suggestions:', error);
            displayError(`Failed to generate suggestions: ${error.message}`);
        }
    }
    
    // Make functions globally available
    window.createWorkflow = function(suggestionId) {
        // TODO: Implement workflow creation
        alert('Workflow creation coming soon!');
    };
    
    window.previewWorkflow = function(suggestionId) {
        // Find the suggestion data - try URL parameters first, then check if we have suggestions in memory
        let suggestions = null;
        let suggestion = null;
        
        try {
            // Try to get from URL parameters first
            const suggestionsParam = urlParams.get('suggestions');
            if (suggestionsParam) {
                suggestions = JSON.parse(decodeURIComponent(suggestionsParam));
                suggestion = suggestions.find(s => s.suggestion_id === suggestionId);
            }
        } catch (error) {
            console.warn('Could not parse suggestions from URL:', error);
        }
        
        // If not found in URL, check if we have suggestions in the DOM
        if (!suggestion) {
            const suggestionsContainer = document.querySelector('.grid.gap-6');
            if (suggestionsContainer) {
                // Try to find the suggestion by looking at the button's parent card
                const button = document.querySelector(`[onclick="previewWorkflow('${suggestionId}')"]`);
                if (button) {
                    const card = button.closest('.border.border-gray-200.rounded-lg');
                    if (card) {
                        // Extract basic info from the card
                        const title = card.querySelector('h3')?.textContent || 'Unknown Workflow';
                        const description = card.querySelector('p.text-gray-600')?.textContent || '';
                        
                        // Create a basic suggestion object
                        suggestion = {
                            suggestion_id: suggestionId,
                            title: title,
                            description: description,
                            dsl_parametric: {},
                            full_workflow_json: {}
                        };
                    }
                }
            }
        }
        
        if (!suggestion) {
            alert('Suggestion not found. Please try refreshing the page.');
            return;
        }
        
        // Show full workflow JSON in a modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="text-lg font-semibold text-gray-900">Workflow Preview: ${suggestion.title}</h3>
                    <button onclick="this.closest('.modal-overlay').remove()" class="modal-close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="text-sm text-gray-600 mb-2">Full Workflow JSON:</p>
                    <pre class="json-preview">${JSON.stringify(suggestion.full_workflow_json || suggestion.dsl_parametric || {}, null, 2)}</pre>
                </div>
                <div class="modal-footer">
                    <button onclick="this.closest('.modal-overlay').remove()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
    };
});
</script>
{% endblock %}
