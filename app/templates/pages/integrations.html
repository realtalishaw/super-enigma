{% extends "base.html" %}

{% block title %}Integrations & Apps{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Integrations & apps</h1>
                    <p class="mt-2 text-gray-600">Connect your favorite tools and automate your workflows</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-600 hover:text-gray-900 text-sm font-medium">
                        Take a look around
                    </button>
                    <button class="text-gray-600 hover:text-gray-900 text-sm font-medium">
                        Invite user
                    </button>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        + Create
                    </button>
                    <div class="w-8 h-8 bg-gray-900 rounded flex items-center justify-center">
                        <span class="text-white text-xs font-bold">S</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Tabs -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8 overflow-x-auto">
                <button class="category-tab active py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm whitespace-nowrap">
                    All integrations
                </button>
                <button class="category-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                    Most used
                </button>
                <button class="category-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                    Video conferencing
                </button>
                <button class="category-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                    Calendars
                </button>
                <button class="category-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                    Marketing
                </button>
                <button class="category-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                    Payments
                </button>
                <button class="category-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                    Email messaging
                </button>
                <button class="category-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                    Sales and CRM
                </button>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center space-x-4">
                <div class="flex-1 max-w-md">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input 
                            type="text" 
                            id="search-input"
                            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            placeholder="Search integrations..."
                        >
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500" id="results-count">Loading integrations...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrations Grid -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="integrations-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Integrations will be loaded here -->
        </div>
        
        <!-- Load More Button -->
        <div id="load-more-container" class="mt-8 text-center hidden">
            <button 
                id="load-more-btn"
                class="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-md text-sm font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
                Load More Integrations
            </button>
        </div>
        
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm text-gray-600">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading integrations...
            </div>
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="text-center py-12 hidden">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No integrations found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your search terms or browse all integrations.</p>
        </div>
    </div>
</div>

<!-- Integration Card Template -->
<template id="integration-card-template">
    <div class="integration-card bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
        <div class="flex items-start justify-between">
            <div class="flex items-center space-x-3 flex-1">
                <div class="integration-icon w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                    <!-- Icon will be inserted here -->
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="integration-name text-sm font-medium text-gray-900 truncate"></h3>
                    <p class="integration-description text-xs text-gray-500 mt-1 line-clamp-2"></p>
                </div>
            </div>
            <div class="integration-status ml-3">
                <!-- Status button will be inserted here -->
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
let currentOffset = 0;
let currentLimit = 10;
let currentSearch = '';
let totalIntegrations = 0;
let isLoading = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadIntegrations();
    setupEventListeners();
});

function setupEventListeners() {
    // Search input with debouncing
    const searchInput = document.getElementById('search-input');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentSearch = this.value.trim();
            currentOffset = 0;
            if (currentSearch) {
                searchIntegrations();
            } else {
                loadIntegrations();
            }
        }, 300);
    });
    
    // Category tabs
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.category-tab').forEach(t => {
                t.classList.remove('active', 'border-blue-500', 'text-blue-600');
                t.classList.add('border-transparent', 'text-gray-500');
            });
            this.classList.add('active', 'border-blue-500', 'text-blue-600');
            this.classList.remove('border-transparent', 'text-gray-500');
            
            // Reset and reload for category filtering
            currentOffset = 0;
            currentSearch = '';
            searchInput.value = '';
            loadIntegrations();
        });
    });
    
    // Load more button
    document.getElementById('load-more-btn').addEventListener('click', function() {
        currentOffset += currentLimit;
        if (currentSearch) {
            searchIntegrations(true);
        } else {
            loadIntegrations(true);
        }
    });
}

async function loadIntegrations(append = false) {
    if (isLoading) return;
    
    isLoading = true;
    showLoading();
    
    try {
        const params = new URLSearchParams({
            limit: currentLimit,
            offset: currentOffset
        });
        
        const response = await fetch(`/api/integrations?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            totalIntegrations = data.total;
            updateResultsCount();
            
            if (append) {
                appendIntegrations(data.items);
            } else {
                renderIntegrations(data.items);
            }
            
            updateLoadMoreButton(data.hasMore);
        } else {
            console.error('Failed to load integrations:', data);
            showEmptyState();
        }
    } catch (error) {
        console.error('Error loading integrations:', error);
        showEmptyState();
    } finally {
        isLoading = false;
        hideLoading();
    }
}

async function searchIntegrations(append = false) {
    if (isLoading) return;
    
    isLoading = true;
    showLoading();
    
    try {
        const params = new URLSearchParams({
            q: currentSearch,
            limit: currentLimit,
            offset: currentOffset
        });
        
        const response = await fetch(`/api/integrations/search?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            totalIntegrations = data.total;
            updateResultsCount();
            
            if (append) {
                appendIntegrations(data.items);
            } else {
                renderIntegrations(data.items);
            }
            
            updateLoadMoreButton(data.items.length === currentLimit);
        } else {
            console.error('Failed to search integrations:', data);
            showEmptyState();
        }
    } catch (error) {
        console.error('Error searching integrations:', error);
        showEmptyState();
    } finally {
        isLoading = false;
        hideLoading();
    }
}

function renderIntegrations(integrations) {
    const grid = document.getElementById('integrations-grid');
    grid.innerHTML = '';
    
    if (integrations.length === 0) {
        showEmptyState();
        return;
    }
    
    integrations.forEach(integration => {
        const card = createIntegrationCard(integration);
        grid.appendChild(card);
    });
    
    hideEmptyState();
}

function appendIntegrations(integrations) {
    const grid = document.getElementById('integrations-grid');
    
    integrations.forEach(integration => {
        const card = createIntegrationCard(integration);
        grid.appendChild(card);
    });
}

function createIntegrationCard(integration) {
    const template = document.getElementById('integration-card-template');
    const card = template.content.cloneNode(true);
    
    // Set integration name
    card.querySelector('.integration-name').textContent = integration.name;
    
    // Set integration description
    card.querySelector('.integration-description').textContent = integration.description || 'No description available';
    
    // Set integration icon
    const iconContainer = card.querySelector('.integration-icon');
    if (integration.logo && integration.logo !== '/static/icons/placeholder.svg') {
        const img = document.createElement('img');
        img.src = integration.logo;
        img.alt = integration.name;
        img.className = 'w-6 h-6';
        iconContainer.innerHTML = '';
        iconContainer.appendChild(img);
    } else {
        iconContainer.innerHTML = `<span class="text-lg font-semibold text-gray-600">${integration.name.charAt(0).toUpperCase()}</span>`;
    }
    
    // Set status button (mock connected status for now)
    const statusContainer = card.querySelector('.integration-status');
    const isConnected = Math.random() > 0.5; // Mock logic - replace with real data
    
    if (isConnected) {
        statusContainer.innerHTML = `
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                Connected
            </span>
        `;
    } else {
        statusContainer.innerHTML = `
            <button class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                Connect
            </button>
        `;
    }
    
    return card;
}

function updateResultsCount() {
    const countElement = document.getElementById('results-count');
    if (currentSearch) {
        const showing = Math.min(currentOffset + currentLimit, totalIntegrations);
        countElement.textContent = `Found ${totalIntegrations} integrations matching "${currentSearch}" (showing ${showing})`;
    } else {
        const showing = Math.min(currentOffset + currentLimit, totalIntegrations);
        countElement.textContent = `Showing ${showing} of ${totalIntegrations} integrations`;
    }
}

function updateLoadMoreButton(hasMore) {
    const container = document.getElementById('load-more-container');
    if (hasMore) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

function showLoading() {
    document.getElementById('loading-state').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading-state').classList.add('hidden');
}

function showEmptyState() {
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('integrations-grid').innerHTML = '';
}

function hideEmptyState() {
    document.getElementById('empty-state').classList.add('hidden');
}
</script>
{% endblock %}
