{% if workflow and workflow.graph %}
    <div class="relative w-full h-full overflow-auto" id="workflow-canvas">
        <!-- SVG for edges -->
        <svg class="absolute inset-0 w-full h-full pointer-events-none">
            {% if workflow.graph.edges %}
                {% for edge in workflow.graph.edges %}
                <path 
                    d="M {{ edge.source.x if edge.source.x else 100 }},{{ edge.source.y if edge.source.y else 100 }} L {{ edge.target.x if edge.target.x else 300 }},{{ edge.target.y if edge.target.y else 100 }}"
                    stroke="#6B7280" 
                    stroke-width="2" 
                    fill="none"
                    marker-end="url(#arrowhead)"
                />
                {% endfor %}
            {% endif %}
            
            <!-- Arrow marker definition -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#6B7280" />
                </marker>
            </defs>
        </svg>
        
        <!-- Nodes -->
        {% if workflow.graph.nodes %}
            {% for node in workflow.graph.nodes %}
            <div 
                class="node absolute bg-white border-2 border-gray-300 rounded-lg p-4 shadow-md cursor-move min-w-[200px]"
                data-node-id="{{ node.id }}"
                style="left: {{ node.position.x if node.position.x else 50 }}px; top: {{ node.position.y if node.position.y else 50 }}px;"
                draggable="true"
            >
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-medium text-gray-900">{{ node.label }}</h4>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                        {% if node.status == 'completed' %}bg-green-100 text-green-800
                        {% elif node.status == 'running' %}bg-blue-100 text-blue-800
                        {% elif node.status == 'error' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ node.status if node.status else 'pending' }}
                    </span>
                </div>
                
                {% if node.description %}
                    <p class="text-sm text-gray-600 mb-3">{{ node.description }}</p>
                {% endif %}
                
                {% if node.type %}
                    <div class="text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded">
                        Type: {{ node.type }}
                    </div>
                {% endif %}
                
                {% if node.error %}
                    <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
                        <strong>Error:</strong> {{ node.error }}
                    </div>
                {% endif %}
            </div>
            {% endfor %}
        {% endif %}
    </div>
    
    <!-- No nodes message -->
    {% if not workflow.graph.nodes %}
        <div class="text-center py-12 text-gray-500">
            <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            <p class="mt-2">No workflow nodes defined</p>
            <p class="text-sm">This workflow doesn't have any steps configured yet</p>
        </div>
    {% endif %}
{% else %}
    <div class="text-center py-12 text-gray-500">
        <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="mt-2">No workflow data available</p>
        <p class="text-sm">Unable to load workflow information</p>
    </div>
{% endif %}

<script>
// Simple drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const nodes = document.querySelectorAll('.node');
    
    nodes.forEach(node => {
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        node.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
            
            if (e.target === node) {
                isDragging = true;
            }
        }
        
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                xOffset = currentX;
                yOffset = currentY;
                
                setTranslate(currentX, currentY, node);
            }
        }
        
        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
        }
        
        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }
    });
});
</script>
